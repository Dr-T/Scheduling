<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>岗编人效智能体</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #f0f2f5;
        }
        .step-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .step-header {
            border-bottom: 1px solid #e5e7eb;
        }
        .btn-primary {
            background-color: #1d4ed8;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #1e40af;
        }
        .btn-secondary {
            background-color: #e0e7ff;
            color: #3730a3;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #c7d2fe;
        }
        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .highlight-card {
            border: 2px solid #2563eb;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.2);
        }
        .kpi-card {
            transition: all 0.3s ease;
        }
        .kpi-value-up { color: #16a34a; }
        .kpi-value-down { color: #dc2626; }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 48rem;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        /* AI-generated content styles */
        .ai-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            color: #1e40af;
        }
        .ai-content ul {
            list-style-type: none;
            padding-left: 0;
        }
        .ai-content li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
            color: #374151;
        }
        .ai-content li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #2563eb;
            font-weight: bold;
        }
        .ai-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 p-3 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain-circuit text-white"><path d="M12 5a3 3 0 1 0-5.993.142"/><path d="M18 5a3 3 0 1 0-5.993.142"/><path d="M5 8.142A3 3 0 1 0 5 14"/><path d="M19 8.142A3 3 0 1 0 19 14"/><path d="M12 14a3 3 0 1 0 5.993-.142"/><path d="M6 14a3 3 0 1 0 5.993-.142"/><path d="M12 5v-2"/><path d="M12 19v2"/><path d="M12 12v-2"/><path d="M12 16v-2"/><path d="M5 8h2"/><path d="M7 14h-2"/><path d="M19 8h-2"/><path d="M17 14h2"/><path d="M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2"/><path d="M9 19a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">岗编人效智能体</h1>
                    <p class="text-gray-500">项目初始化岗编模拟系统</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="space-y-8">
            <!-- Step 1: Project Profiling -->
            <div id="step-1" class="step-card p-6 md:p-8">
                <div class="step-header pb-4 mb-6 flex items-center justify-between">
                     <div class="flex items-center space-x-3">
                        <div class="bg-blue-100 text-blue-700 font-bold w-10 h-10 flex items-center justify-center rounded-full">1</div>
                        <h2 class="text-xl font-semibold text-gray-700">项目画像数据采集</h2>
                    </div>
                </div>
                <p class="text-gray-600 mb-6">在项目接管前，输入新项目的“基因”数据，为智能体分析提供基础。</p>
                <form id="project-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="projectName" class="block text-sm font-medium text-gray-700">项目名称</label>
                        <input type="text" id="projectName" value="未来城" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="area" class="block text-sm font-medium text-gray-700">总建筑面积 (万m²)</label>
                        <input type="number" id="area" value="30" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="households" class="block text-sm font-medium text-gray-700">总户数</label>
                        <input type="number" id="households" value="1500" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-700">楼龄 (年)</label>
                        <input type="number" id="age" value="2" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="equipment" class="block text-sm font-medium text-gray-700">核心设备复杂度</label>
                        <select id="equipment" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="1.0">低 (常规设备)</option>
                            <option value="1.5" selected>中 (含大型中央空调)</option>
                            <option value="2.0">高 (含老旧/特殊设备)</option>
                        </select>
                    </div>
                    <div>
                        <label for="sla" class="block text-sm font-medium text-gray-700">合同服务等级 (SLA)</label>
                        <select id="sla" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="1.0">标准</option>
                            <option value="1.2" selected>高 (如2h内关单)</option>
                            <option value="1.5">极高 (定制化服务)</option>
                        </select>
                    </div>
                </form>
                <div class="mt-8 text-right">
                    <button id="analyze-btn" class="btn-primary font-semibold py-2 px-6 rounded-lg shadow-md flex items-center justify-center ml-auto">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i>
                        开始分析
                    </button>
                </div>
            </div>

            <!-- Step 2: SHEU Analysis -->
            <div id="step-2" class="step-card p-6 md:p-8 hidden fade-in">
                 <div class="step-header pb-4 mb-6 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="bg-blue-100 text-blue-700 font-bold w-10 h-10 flex items-center justify-center rounded-full">2</div>
                        <h2 class="text-xl font-semibold text-gray-700">SHEU分析与“孪生项目”对标</h2>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-blue-50 p-6 rounded-lg text-center">
                        <h3 id="sheu-title" class="text-lg font-medium text-gray-600">项目SHEU得分</h3>
                        <p id="sheu-score" class="text-6xl font-bold text-blue-600 my-4">85</p>
                        <p class="text-gray-500 text-sm">该分数代表项目的理论总工作负荷，分数越高，所需人力资源越多。</p>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-lg font-medium text-gray-800 mb-4">智能匹配的“孪生项目”</h3>
                        <div id="lookalike-projects" class="space-y-4"></div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Baseline Staffing -->
            <div id="step-3" class="step-card p-6 md:p-8 hidden fade-in">
                 <div class="step-header pb-4 mb-6 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="bg-blue-100 text-blue-700 font-bold w-10 h-10 flex items-center justify-center rounded-full">3</div>
                        <h2 class="text-xl font-semibold text-gray-700">V1.0 初始化基准岗编建议</h2>
                    </div>
                </div>
                <div id="baseline-reason" class="bg-green-50 border-l-4 border-green-500 text-green-800 p-4 rounded-r-lg mb-6 min-h-[100px] flex items-center justify-center">
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">岗位</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">建议人数</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">能力画像建议</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI 智能助理</th>
                            </tr>
                        </thead>
                        <tbody id="baseline-table" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 4: Optimization Simulation -->
            <div id="step-4" class="step-card p-6 md:p-8 hidden fade-in">
                 <div class="step-header pb-4 mb-6 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="bg-blue-100 text-blue-700 font-bold w-10 h-10 flex items-center justify-center rounded-full">4</div>
                        <h2 class="text-xl font-semibold text-gray-700">V2.0 岗编优化模拟器 (What-If)</h2>
                    </div>
                </div>
                <p class="text-gray-600 mb-6">您可以调整V1.0方案，系统将实时预测成本与服务品质变化，辅助您做出最优决策。</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="kpi-card bg-gray-50 p-4 rounded-lg text-center">
                        <h4 class="text-sm font-medium text-gray-500">预估月度人力成本</h4>
                        <p id="kpi-cost" class="text-2xl font-bold text-gray-800 mt-1">¥0</p>
                        <p id="kpi-cost-change" class="text-sm font-medium"></p>
                    </div>
                    <div class="kpi-card bg-gray-50 p-4 rounded-lg text-center">
                        <h4 class="text-sm font-medium text-gray-500">预估客户满意度</h4>
                        <p id="kpi-satisfaction" class="text-2xl font-bold text-gray-800 mt-1">0%</p>
                         <p id="kpi-satisfaction-change" class="text-sm font-medium"></p>
                    </div>
                    <div class="kpi-card bg-gray-50 p-4 rounded-lg text-center">
                        <h4 class="text-sm font-medium text-gray-500">预估工单响应效率</h4>
                        <p id="kpi-efficiency" class="text-2xl font-bold text-gray-800 mt-1">0%</p>
                         <p id="kpi-efficiency-change" class="text-sm font-medium"></p>
                    </div>
                </div>

                 <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">岗位</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">V1.0 建议</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">V2.0 调整</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI 智能助理</th>
                            </tr>
                        </thead>
                        <tbody id="simulation-table" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div class="mt-6 flex flex-wrap gap-4 justify-end">
                    <button id="add-role-btn" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-50 flex items-center">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                        增加新岗位
                    </button>
                    <button id="device-recommendation-btn" class="btn-secondary font-semibold py-2 px-4 rounded-lg flex items-center">
                        <i data-lucide="cpu" class="w-4 h-4 mr-2"></i>
                        ✨ 智能设备建议
                    </button>
                    <button id="risk-assessment-btn" class="btn-secondary font-semibold py-2 px-4 rounded-lg flex items-center">
                        <i data-lucide="shield-alert" class="w-4 h-4 mr-2"></i>
                        ✨ AI风险评估
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Modal -->
    <div id="ai-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-2xl font-bold text-gray-800"></h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="ai-modal-body" class="ai-content"></div>
        </div>
    </div>

    <script>
        // --- MOCK DATA ---
        const mockProjects = [
            { id: 'A', name: '滨江壹号', sheu: 83, satisfaction: 92, cost: 280000, staffing: [
                { role: '项目经理', count: 1, salary: 20000, satisfactionImpact: 5, efficiencyImpact: 5 },
                { role: '客服管家', count: 4, salary: 8000, satisfactionImpact: 10, efficiencyImpact: 8 },
                { role: '维修工程师', count: 3, salary: 10000, satisfactionImpact: 8, efficiencyImpact: 15 },
                { role: '安保班长', count: 1, salary: 8000, satisfactionImpact: 3, efficiencyImpact: 3 },
                { role: '安保员', count: 12, salary: 6000, satisfactionImpact: 5, efficiencyImpact: 5 },
                { role: '保洁主管', count: 1, salary: 7000, satisfactionImpact: 2, efficiencyImpact: 2 },
                { role: '保洁员', count: 15, salary: 4500, satisfactionImpact: 6, efficiencyImpact: 4 },
            ], model: '传统模式' },
            { id: 'B', name: '云端华府', sheu: 87, satisfaction: 95, cost: 265000, staffing: [
                { role: '项目经理', count: 1, salary: 20000, satisfactionImpact: 5, efficiencyImpact: 5 },
                { role: '服务管家', count: 5, salary: 12000, satisfactionImpact: 15, efficiencyImpact: 15, note: '客服与基础工程巡检合并' },
                { role: '资深暖通工程师', count: 1, salary: 15000, satisfactionImpact: 5, efficiencyImpact: 10, note: '应对复杂设备' },
                { role: '维修工程师', count: 1, salary: 10000, satisfactionImpact: 5, efficiencyImpact: 10 },
                { role: '安保班长', count: 1, salary: 8000, satisfactionImpact: 3, efficiencyImpact: 3 },
                { role: '安保员', count: 10, salary: 6000, satisfactionImpact: 5, efficiencyImpact: 5 },
                { role: '保洁主管', count: 1, salary: 7000, satisfactionImpact: 2, efficiencyImpact: 2 },
                { role: '保洁员', count: 12, salary: 4500, satisfactionImpact: 6, efficiencyImpact: 4 },
            ], model: '大管家模式' },
            { id: 'C', name: '水晶之城', sheu: 86, satisfaction: 90, cost: 295000, staffing: [
                { role: '项目经理', count: 1, salary: 20000, satisfactionImpact: 5, efficiencyImpact: 5 },
                { role: '客服管家', count: 5, salary: 8000, satisfactionImpact: 10, efficiencyImpact: 8 },
                { role: '维修工程师', count: 4, salary: 10000, satisfactionImpact: 8, efficiencyImpact: 15 },
                { role: '安保班长', count: 1, salary: 8000, satisfactionImpact: 3, efficiencyImpact: 3 },
                { role: '安保员', count: 14, salary: 6000, satisfactionImpact: 5, efficiencyImpact: 5 },
                { role: '保洁主管', count: 1, salary: 7000, satisfactionImpact: 2, efficiencyImpact: 2 },
                { role: '保洁员', count: 16, salary: 4500, satisfactionImpact: 6, efficiencyImpact: 4 },
            ], model: '传统模式' },
        ];
        
        // --- DOM ELEMENTS ---
        const analyzeBtn = document.getElementById('analyze-btn');
        const addRoleBtn = document.getElementById('add-role-btn');
        const riskAssessmentBtn = document.getElementById('risk-assessment-btn');
        const deviceRecommendationBtn = document.getElementById('device-recommendation-btn');
        const steps = {
            1: document.getElementById('step-1'),
            2: document.getElementById('step-2'),
            3: document.getElementById('step-3'),
            4: document.getElementById('step-4'),
        };
        const modal = document.getElementById('ai-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');

        let projectData = {};
        let currentStaffing = [];
        let baselineStaffing = [];
        let baseKPIs = { cost: 0, satisfaction: 0, efficiency: 0 };
        
        const loadingSpinner = `<div class="flex justify-center items-center h-full"><div class="spinner w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full"></div></div>`;
        
        // --- UTILITY FUNCTIONS ---
        function markdownToHtml(text) {
            let html = text
                .replace(/\*\*(.*?)\*\*/g, '<h3 class="text-lg font-semibold mt-6 mb-3 pb-2 border-b border-gray-200 text-indigo-800">$1</h3>')
                .replace(/### (.*?)\n/g, '<h4 class="text-md font-semibold mt-4 mb-2 text-gray-700">$1</h4>')
                .replace(/\* (.*?)\n/g, '<li class="flex items-start mb-2"><span class="mr-2 text-blue-500 mt-1">&bull;</span><span>$1</span></li>')
                .replace(/(\n- (.*?))+/g, (match) => `<ul>${match.replace(/\n- (.*?)/g, '<li>$1</li>')}</ul>`)
                .replace(/\[(高|中|低)风险\]/g, (match, p1) => {
                    const colors = { '高': 'red', '中': 'yellow', '低': 'green' };
                    const color = colors[p1];
                    return `<span class="bg-${color}-100 text-${color}-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${p1}风险</span>`;
                })
                .replace(/\n/g, '<br>');

            // Wrap list items in a ul if they are not already
            if (html.includes('<li>') && !html.includes('<ul>')) {
                html = `<ul>${html}</ul>`;
            }
            return html;
        }

        // --- GEMINI API CALL ---
        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, retries, delay })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success && result.content) {
                    return markdownToHtml(result.content);
                } else {
                    throw new Error(result.error || "Invalid response from API");
                }
            } catch (error) {
                console.error('API call failed:', error);
                return "抱歉，AI分析时遇到问题，请稍后再试。";
            }
        }

        // --- CORE LOGIC ---
        function getProjectData() {
            return {
                name: document.getElementById('projectName').value,
                area: document.getElementById('area').value,
                households: document.getElementById('households').value,
                age: document.getElementById('age').value,
                equipmentFactor: document.getElementById('equipment').value,
                equipmentText: document.getElementById('equipment').options[document.getElementById('equipment').selectedIndex].text,
                slaFactor: document.getElementById('sla').value,
                slaText: document.getElementById('sla').options[document.getElementById('sla').selectedIndex].text,
            };
        }

        function calculateSHEU(data) {
            const score = (parseFloat(data.area) * 0.5 + parseFloat(data.households) * 0.02 + (parseFloat(data.age) > 5 ? parseFloat(data.age) * 1.5 : 0)) * parseFloat(data.equipmentFactor) * parseFloat(data.slaFactor);
            return Math.round(score);
        }

        function findLookAlikes(sheu) {
            return mockProjects
                .map(p => ({ ...p, diff: Math.abs(p.sheu - sheu) }))
                .sort((a, b) => a.diff - b.diff)
                .slice(0, 3);
        }

        function renderLookAlikes(projects) {
            const container = document.getElementById('lookalike-projects');
            container.innerHTML = '';
            projects.forEach((p, index) => {
                const isBest = index === 0;
                container.innerHTML += `
                    <div class="border ${isBest ? 'highlight-card' : 'border-gray-200'} p-4 rounded-lg relative">
                        ${isBest ? '<span class="absolute top-2 right-2 bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-full">最优对标</span>' : ''}
                        <h4 class="font-semibold text-gray-800">${p.name} <span class="text-sm font-normal text-gray-500">(${p.model})</span></h4>
                        <div class="flex justify-between items-center mt-2 text-sm">
                            <span class="text-gray-600">SHEU: <b class="text-blue-600">${p.sheu}</b></span>
                            <span class="text-gray-600">满意度: <b class="text-green-600">${p.satisfaction}%</b></span>
                            <span class="text-gray-600">月成本: <b class="text-red-600">¥${(p.cost/10000).toFixed(1)}w</b></span>
                        </div>
                    </div>
                `;
            });
        }

        async function generateBaselineStaffing(bestProject) {
            const reasonContainer = document.getElementById('baseline-reason');
            reasonContainer.innerHTML = loadingSpinner;

            const prompt = `你是一位物业管理AI分析专家。请根据以下表现最优的“孪生项目”数据，为新项目“${projectData.name}”生成一段简洁、专业的初始化岗编分析建议。请解释为什么推荐它的模式，并着重强调其优势。\n\n对标项目名称: ${bestProject.name}\n对标项目模式: ${bestProject.model}\n关键人效指标: 客户满意度 ${bestProject.satisfaction}%, 月度成本 ¥${bestProject.cost.toLocaleString()}\n\n请直接输出分析建议文本，使用加粗标题和要点，使其清晰易读。`;
            
            const aiReason = await callGeminiAPI(prompt);
            reasonContainer.innerHTML = `<div class="text-left">${aiReason}</div>`;

            const tableBody = document.getElementById('baseline-table');
            tableBody.innerHTML = '';
            bestProject.staffing.forEach(role => {
                tableBody.innerHTML += `
                    <tr>
                        <td class="py-3 px-6 text-sm font-medium text-gray-900">${role.role}</td>
                        <td class="py-3 px-6 text-sm text-gray-500">${role.count}</td>
                        <td class="py-3 px-6 text-sm text-gray-500">${role.note || '常规'}</td>
                        <td class="py-3 px-6 text-sm text-gray-500">
                            <button class="btn-secondary text-xs font-semibold py-1 px-3 rounded-full generate-jd-btn" data-role="${role.role}">✨ 生成JD</button>
                        </td>
                    </tr>
                `;
            });
            
            baselineStaffing = JSON.parse(JSON.stringify(bestProject.staffing));
            currentStaffing = JSON.parse(JSON.stringify(bestProject.staffing));
        }

        function setupSimulation() {
            const tableBody = document.getElementById('simulation-table');
            tableBody.innerHTML = '';
            currentStaffing.forEach((role, index) => {
                const baseRole = baselineStaffing.find(r => r.role === role.role);
                const baseCount = baseRole ? baseRole.count : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-6 text-sm font-medium text-gray-900">${role.role}</td>
                    <td class="py-3 px-6 text-sm text-gray-500">${baseCount}</td>
                    <td class="py-3 px-6">
                        <div class="flex items-center space-x-2">
                            <button data-action="decrease" data-index="${index}" class="p-1 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-600">-</button>
                            <input type="number" value="${role.count}" data-index="${index}" class="w-16 text-center border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <button data-action="increase" data-index="${index}" class="p-1 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-600">+</button>
                        </div>
                    </td>
                    <td class="py-3 px-6 text-sm text-gray-500">
                         <button class="btn-secondary text-xs font-semibold py-1 px-3 rounded-full generate-jd-btn" data-role="${role.role}">✨ 生成JD</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateSimulationResults(true);
        }

        function handleSimulationChange(e) {
            const target = e.target;
            const action = target.dataset.action;
            const index = target.dataset.index || target.closest('td').querySelector('input')?.dataset.index;

            if (index === undefined) return;

            const input = document.querySelector(`#simulation-table input[data-index='${index}']`);
            let value = parseInt(input.value);

            if (action === 'increase') value++;
            if (action === 'decrease' && value > 0) value--;
            if (target.tagName === 'INPUT') value = parseInt(target.value) || 0;
            
            if (value >= 0) {
                input.value = value;
                currentStaffing[index].count = value;
                updateSimulationResults();
            }
        }
        
        function updateSimulationResults(isInitial = false) {
            let totalCost = 0, totalSatisfactionImpact = 0, totalEfficiencyImpact = 0;
            currentStaffing.forEach(role => {
                totalCost += role.count * role.salary;
                totalSatisfactionImpact += role.count * role.satisfactionImpact;
                totalEfficiencyImpact += role.count * role.efficiencyImpact;
            });
            
            const satisfaction = Math.min(100, Math.round(totalSatisfactionImpact * 0.5));
            const efficiency = Math.min(100, Math.round(totalEfficiencyImpact * 0.4));

            if (isInitial) {
                baseKPIs = { cost: totalCost, satisfaction: satisfaction, efficiency: efficiency };
            }

            document.getElementById('kpi-cost').textContent = `¥${totalCost.toLocaleString()}`;
            document.getElementById('kpi-satisfaction').textContent = `${satisfaction}%`;
            document.getElementById('kpi-efficiency').textContent = `${efficiency}%`;

            updateChangeIndicator(document.getElementById('kpi-cost-change'), totalCost, baseKPIs.cost, true);
            updateChangeIndicator(document.getElementById('kpi-satisfaction-change'), satisfaction, baseKPIs.satisfaction);
            updateChangeIndicator(document.getElementById('kpi-efficiency-change'), efficiency, baseKPIs.efficiency);
        }

        function updateChangeIndicator(el, current, base, isCost = false) {
            const diff = current - base;
            if (diff === 0) { el.innerHTML = ''; return; }
            const direction = diff > 0 ? 'up' : 'down';
            const symbol = diff > 0 ? '▲' : '▼';
            const value = isCost ? `¥${Math.abs(diff).toLocaleString()}` : `${Math.abs(diff)}%`;
            let colorClass = ((isCost && direction === 'down') || (!isCost && direction === 'up')) ? 'kpi-value-up' : 'kpi-value-down';
            el.innerHTML = `<span class="${colorClass}">${symbol} ${value}</span>`;
        }

        function addNewRole() {
            const roleName = prompt("请输入新岗位名称:", "线上社群运营");
            if (!roleName) return;
            const salary = parseInt(prompt("请输入该岗位月薪:", "7000"));
            if (isNaN(salary)) return;

            const newRole = {
                role: roleName, count: 1, salary: salary, satisfactionImpact: 4, efficiencyImpact: 2, note: '新增岗位'
            };
            currentStaffing.push(newRole);
            
            const tableBody = document.getElementById('simulation-table');
            const index = currentStaffing.length - 1;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-3 px-6 text-sm font-medium text-gray-900">${newRole.role}</td>
                <td class="py-3 px-6 text-sm text-gray-500">0</td>
                <td class="py-3 px-6">
                    <div class="flex items-center space-x-2">
                        <button data-action="decrease" data-index="${index}" class="p-1 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-600">-</button>
                        <input type="number" value="1" data-index="${index}" class="w-16 text-center border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <button data-action="increase" data-index="${index}" class="p-1 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-600">+</button>
                    </div>
                </td>
                <td class="py-3 px-6 text-sm text-gray-500">
                    <button class="btn-secondary text-xs font-semibold py-1 px-3 rounded-full generate-jd-btn" data-role="${newRole.role}">✨ 生成JD</button>
                </td>
            `;
            tableBody.appendChild(row);
            updateSimulationResults();
        }

        function openAiModal(title, body) {
            document.getElementById('ai-modal-title').textContent = title;
            document.getElementById('ai-modal-body').innerHTML = body;
            modal.classList.add('visible');
        }
        
        async function handleGenerateJd(e) {
            if (!e.target.classList.contains('generate-jd-btn')) return;
            
            const roleName = e.target.dataset.role;
            openAiModal(`${roleName} - 岗位职责说明书`, loadingSpinner);

            const prompt = `你是一位专业的龙湖智创生活HR专家。请为“${projectData.name}”项目（一个拥有${projectData.households}户、${projectData.area}万平米的高端住宅）生成一份详细、专业的“${roleName}”岗位职责说明书(JD)。JD需包含“**主要工作职责**”和“**任职资格要求**”两大板块，语言要专业且吸引人，请使用列表要点形式。`;
            
            const jdContent = await callGeminiAPI(prompt);
            document.getElementById('ai-modal-body').innerHTML = jdContent;
        }

        async function handleRiskAssessment() {
            openAiModal('V2.0 方案AI风险评估', loadingSpinner);

            const baselineStr = baselineStaffing.map(r => `${r.role}: ${r.count}人`).join('; ');
            const currentStr = currentStaffing.map(r => `${r.role}: ${r.count}人`).join('; ');

            const prompt = `你是一位经验丰富的物业管理风险控制专家。请对比以下两个岗编方案，为“${projectData.name}”项目分析V2.0方案可能存在的潜在风险。请以要点形式，使用清晰的标题（如**服务品质风险**、**安全管理风险**）进行分析。对于每项风险，请简要说明并给出1-2条核心规避建议。格式要清晰，易于阅读。\n\n**V1.0 基准方案:**\n${baselineStr}\n\n**V2.0 优化方案:**\n${currentStr}`;

            const riskContent = await callGeminiAPI(prompt);
            document.getElementById('ai-modal-body').innerHTML = riskContent;
        }

        async function handleDeviceRecommendation() {
            openAiModal('项目智能化设备建议', loadingSpinner);

            const prompt = `你是一位智慧社区解决方案专家。请根据以下项目信息，为“${projectData.name}”项目推荐3种最合适的智能化设备或系统，以帮助其优化人力、降本增效。请说明每种设备的作用、适用场景以及它能如何替代或辅助人力。请使用加粗标题和要点列表，让结论清晰、可视化。\n\n**项目信息:**\n- 项目名称: ${projectData.name}\n- 总面积: ${projectData.area}万平方米\n- 总户数: ${projectData.households}户\n- 设备复杂度: ${projectData.equipmentText}`;

            const deviceContent = await callGeminiAPI(prompt);
            document.getElementById('ai-modal-body').innerHTML = deviceContent;
        }

        // --- EVENT LISTENERS ---
        analyzeBtn.addEventListener('click', async () => {
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = `<div class="spinner w-5 h-5 mr-2"></div> 分析中...`;
            
            projectData = getProjectData();
            document.getElementById('sheu-title').textContent = `“${projectData.name}”项目SHEU得分`;
            const sheuScore = calculateSHEU(projectData);
            document.getElementById('sheu-score').textContent = sheuScore;
            const lookAlikes = findLookAlikes(sheuScore);
            renderLookAlikes(lookAlikes);
            steps[2].classList.remove('hidden');
            
            const bestProject = lookAlikes[0];
            await generateBaselineStaffing(bestProject);
            steps[3].classList.remove('hidden');

            setupSimulation();
            steps[4].classList.remove('hidden');

            steps[2].scrollIntoView({ behavior: 'smooth' });
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = `<i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i> 开始分析`;
            lucide.createIcons();
        });

        addRoleBtn.addEventListener('click', addNewRole);
        riskAssessmentBtn.addEventListener('click', handleRiskAssessment);
        deviceRecommendationBtn.addEventListener('click', handleDeviceRecommendation);
        
        document.getElementById('simulation-table').addEventListener('click', handleSimulationChange);
        document.getElementById('simulation-table').addEventListener('input', handleSimulationChange);
        
        document.body.addEventListener('click', handleGenerateJd);

        closeModalBtn.addEventListener('click', () => modal.classList.remove('visible'));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('visible');
            }
        });

        // --- INITIALIZATION ---
        lucide.createIcons();
    </script>
</body>
</html>
